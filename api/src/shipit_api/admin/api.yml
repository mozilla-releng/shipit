---
openapi: 3.0.1
info:
  title: Ship-It API
  description: |
    Find  out more about Ship-it at
    [https://github.com/mozilla-releng/shipit](https://github.com/mozilla-releng/shipit)
  license:
    name: MPL 2.0
    url: https://www.mozilla.org/MPL/2.0/
  version: 1.0.0
servers:
- url: /
paths:
  /product-details:
    post:
      summary: Trigger a rebuild of product details
      operationId: shipit_api.admin.api.rebuild_product_details
      requestBody:
        description: Rebuild options
        content:
          application/json:
            schema:
              type: object
              properties:
                breakpoint_version:
                  type: integer
                clean_working_copy:
                  type: boolean
                channel:
                  type: string
                folder_in_repo:
                  type: string
        required: false
      responses:
        200:
          description: Product details rebuild triggered.
          content: {}
        405:
          description: Invalid input
          content: {}
  /releases:
    get:
      summary: List releases
      operationId: shipit_api.public.api.list_releases
      parameters:
      - name: product
        in: query
        schema:
          type: string
      - name: branch
        in: query
        schema:
          type: string
      - name: version
        in: query
        schema:
          type: string
      - name: build_number
        in: query
        schema:
          type: integer
      - name: status
        in: query
        style: form
        description: >
            Defaults to listing only "scheduled" releases. Currently supported
            values are "scheduled", "shipped", and "aborted".
        explode: false
        schema:
          type: array
          items:
            type: string
      responses:
        200:
          description: A list of releases
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Release'
    post:
      summary: Add a new release
      operationId: shipit_api.admin.api.add_release
      requestBody:
        description: Release object
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReleaseInput'
        required: true
      responses:
        201:
          description: Release added
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Release'
        405:
          description: Invalid input
          content: {}
  /releases/{name}:
    get:
      summary: Release info
      operationId: shipit_api.public.api.get_release
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      responses:
        200:
          description: Returns release representation
          content:
            'application/json':
              schema:
                anyOf:
                  - $ref: '#/components/schemas/Release'
                  - $ref: '#/components/schemas/XPIRelease'
    delete:
      summary: Release info
      operationId: shipit_api.admin.api.abandon_release
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      responses:
        200:
          description: Returns release representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Release'
    patch:
      summary: Update release status
      operationId: shipit_api.admin.api.update_release_status
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      requestBody:
        description: Release status object
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReleaseStatus'
        required: true
      responses:
        200:
          description: Release updated
          content:
            'application/json':
              schema:
                anyOf:
                  - $ref: '#/components/schemas/Release'
                  - $ref: '#/components/schemas/XPIRelease'
        405:
          description: Invalid input
          content: {}
  /releases/{name}/{phase}:
    get:
      summary: Release info
      operationId: shipit_api.public.api.get_phase
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Retruns phase representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Phase'
    put:
      summary: Schedule phase
      operationId: shipit_api.admin.api.schedule_phase
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Phase scheduled
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Phase'
        409:
          description: Already submitted
          content: {}
  /signoff/{name}/{phase}:
    get:
      summary: Get phase signoff requirements and status
      operationId: shipit_api.public.api.get_phase_signoff
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Retruns phase signoff representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Signoffs'
    put:
      summary: Sign off a phase
      operationId: shipit_api.admin.api.phase_signoff
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      requestBody:
        description: Signoff UID
        content:
          'application/json':
            schema:
              type: string
        required: true
      responses:
        200:
          description: Retruns phase signoff representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Signoffs'
        409:
          description: Already submitted
          content: {}
  /disabled-products:
    get:
      summary: Get the list of product/branches which are currently disabled. Disabled products/branches will not have automated releases created
      operationId: shipit_api.public.api.get_disabled_products
      responses:
        200:
          description: Disabled product/branches
          content:
            application/json:
              schema:
                type: object
    post:
      summary: Disable a product+branch
      operationId: shipit_api.admin.api.disable_product
      requestBody:
        description: Disable Product object
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisableProduct'
      responses:
        200:
          description: OK
        405:
          description: Invalid input
    delete:
      summary: Enable a product+branch
      operationId: shipit_api.admin.api.enable_product
      parameters:
      - name: product
        in: query
        required: true
        schema:
          type: string
          enum:
          - firefox
          - devedition
      - name: branch
        in: query
        required: true
        schema:
          type: string
          enum:
          - projects/maple
          - releases/mozilla-esr68
          - releases/mozilla-beta
          - try
      responses:
        200:
          description: OK
        405:
          description: Invalid input
  /github/branches/{owner}/{repo}:
    get:
      summary: List git branches of a Github repo
      operationId: shipit_api.admin.github.list_github_branches
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      responses:
        200:
          description: List of git branches
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /github/commits/{owner}/{repo}:
    get:
      summary: List git commits in a Github repo
      operationId: shipit_api.admin.github.list_github_commits
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      - name: branch
        in: query
        required: true
        description: branch name
        schema:
          type: string
      responses:
        200:
          description: List of git commits
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /github/package_json/{owner}/{repo}/{revision}:
    get:
      summary: Returns contents of package.json from a github repo's root directory
      operationId: shipit_api.admin.github.get_package_json
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      - name: revision
        in: path
        required: true
        description: commit revision
        schema:
          type: string
      responses:
        200:
          description: Contents of package.json
          content:
            application/json:
              schema:
                type: object
  /github/package_json/{owner}/{repo}/{revision}/{directory}:
    get:
      summary: Returns contents of package.json from a github repo's root directory
      operationId: shipit_api.admin.github.get_package_json_directory
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      - name: revision
        in: path
        required: true
        description: commit revision
        schema:
          type: string
      - name: directory
        in: path
        required: true
        description: directory path
        schema:
          type: string
      responses:
        200:
          description: Contents of package.json
          content:
            application/json:
              schema:
                type: object
  /github/version_txt/{owner}/{repo}/{revision}:
    get:
      summary: Returns contents of version.txt from a github repo's root directory
      operationId: shipit_api.admin.github.get_version_txt
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      - name: revision
        in: path
        required: true
        description: commit revision
        schema:
          type: string
      responses:
        200:
          description: Contents of version.txt
          content:
            text/plain:
              schema:
                oneOf:
                  - type: string
                  # Bug 1815414 text/plain gets parsed as JSON object[1] when
                  # connexion validates the output. This means "110.0" becomes
                  # a number. That's why we're accepting both here.
                  #
                  # [1] https://github.com/spec-first/connexion/pull/205/files#diff-dfd9a45381cefd560da87f04925f10801539c6d5c45e4f1f3ecb08e06e9fe273R88
                  - type: number
                example: 1.0.0
  /github/xpis/{owner}/{repo}/{revision}:
    get:
      summary: List XPIs in the manifest
      operationId: shipit_api.admin.github.list_xpis
      parameters:
      - name: owner
        in: path
        required: true
        description: repo owner
        schema:
          type: string
      - name: repo
        in: path
        required: true
        description: repo name
        schema:
          type: string
      - name: revision
        required: true
        in: path
        description: commit revision
        schema:
          type: string
      responses:
        200:
          description: List of XPIs in a manifest
          content:
            application/json:
              schema:
                type: object
  /xpi/releases:
    get:
      summary: List XPI releases
      operationId: shipit_api.admin.xpi.list_releases
      parameters:
      - name: xpi_name
        in: query
        schema:
          type: string
      - name: xpi_version
        in: query
        schema:
          type: string
      - name: build_number
        in: query
        schema:
          type: integer
      - name: status
        in: query
        style: form
        explode: false
        schema:
          type: array
          items:
            type: string
      responses:
        200:
          description: A list of releases
          content:
            'application/json':
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/XPIRelease'
    post:
      summary: Add a new XPI release
      operationId: shipit_api.admin.xpi.add_release
      requestBody:
        description: XPI Release object
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/XPIReleaseInput'
        required: true
      responses:
        201:
          description: Release added
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/XPIRelease'
  /xpi/releases/{name}:
    get:
      summary: Release info
      operationId: shipit_api.admin.xpi.get_release
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      responses:
        200:
          description: Returns release representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/XPIRelease'
    delete:
      summary: Release info
      operationId: shipit_api.admin.xpi.abandon_release_xpi
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      responses:
        200:
          description: Returns release representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/XPIRelease'

  /xpi/releases/{name}/{phase}:
    get:
      summary: Phase info
      operationId: shipit_api.admin.xpi.get_phase
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Retruns phase representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Phase'
    put:
      summary: Schedule phase
      operationId: shipit_api.admin.xpi.schedule_phase
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Phase scheduled
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Phase'
        409:
          description: Already submitted
          content: {}
  /xpi/signoff/{name}/{phase}:
    get:
      summary: Get phase signoff requirements and status
      operationId: shipit_api.admin.xpi.get_phase_signoff
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      responses:
        200:
          description: Retruns phase signoff representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Signoffs'
    put:
      summary: Sign off a phase
      operationId: shipit_api.admin.xpi.phase_signoff
      parameters:
      - name: name
        in: path
        description: release name
        required: true
        schema:
          type: string
      - name: phase
        in: path
        required: true
        schema:
          type: string
      requestBody:
        description: Signoff UID
        content:
          'application/json':
            schema:
              type: string
        required: true
      responses:
        200:
          description: Retruns phase signoff representation
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/Signoffs'
        409:
          description: Already submitted
          content: {}
components:
  schemas:
    ReleaseInput:
      required:
      - branch
      - build_number
      - product
      - revision
      - version
      type: object
      properties:
        product:
          type: string
          example: firefox
          enum:
          - app-services
          - devedition
          - firefox
          - firefox-android
          - thunderbird
        version:
          type: string
          example: 56.0b12
        branch:
          type: string
          example: projects/maple
        revision:
          type: string
          example: abcd1234
        build_number:
          type: integer
          example: 12
        release_eta:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
        partial_updates:
          anyOf:
            - type: object
              # Using additionalProperties allows having properties with names
              # unknown in advance, like versions used here.
              additionalProperties:
                type: object
                required:
                  - buildNumber
                  - locales
                additionalProperties: false
                properties:
                  buildNumber:
                    type: integer
                  locales:
                    type: array
                    items:
                      type: string
            - type: string
              enum: [auto]
        product_key:
          type: string
          example: fennec_beta
        repo_url:
          type: string
          example: https://github.com/mozilla-mobile/firefox-android
    ReleaseStatus:
      required:
      - status
      type: object
      properties:
        status:
          type: string
          example: scheduled
          enum:
          - scheduled
          - shipped
          - aborted
    Phase:
      required:
      - name
      - submitted
      type: object
      properties:
        name:
          type: string
          description: Release promotion phase name
          example: promote_firefox
        submitted:
          type: boolean
          description: Indicated if the phase was submitted to TC
        skipped:
          type: boolean
          description: Indicated if the phase was skipped
        actionTaskId:
          type: string
          description: Action Task ID for the phase. This is also the taskGroupId
            for the tasks created for this phase.
        created:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
        completed:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
    Release:
      required:
      - branch
      - build_number
      - name
      - phases
      - product
      - revision
      - status
      - version
      type: object
      properties:
        name:
          type: string
          example: firefox-69.0b1-build1
        product:
          type: string
          example: firefox
          enum:
          - android-components
          - app-services
          - devedition
          - fenix
          - fennec
          - firefox
          - firefox-android
          - focus-android
          - thunderbird
        version:
          type: string
          example: 56.0b12
        branch:
          type: string
          example: projects/maple
        project:
          type: string
          example: maple
        revision:
          type: string
          example: abcd1234
        build_number:
          type: integer
          example: 12
        release_eta:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
        status:
          type: string
          example: scheduled
          enum:
          - scheduled
          - shipped
          - aborted
        phases:
          type: array
          items:
            $ref: '#/components/schemas/Phase'
        created:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
        completed:
          type: string
          format: dateTime
          example: "2017-12-21T15:10:00-05:00"
        allow_phase_skipping:
          type: boolean
          description: Allow skipping phases. In this case the snowman release model will not skipped phases.
    Signoffs:
      required:
      - signoffs
      type: object
      properties:
        signoffs:
          type: array
          items:
            $ref: '#/components/schemas/Signoff'
        deadline:
          type: string
          description: Deadline of all signoffs
          format: datetime
    Signoff:
      required:
      - description
      - name
      - permissions
      - uid
      type: object
      properties:
        uid:
          type: string
          description: Unique identifier
        name:
          type: string
          description: Human readable signoff name
        description:
          type: string
          description: Human readable explanation of the signoff
        signed:
          type: boolean
          description: Is the signoff signed off
          default: false
        permissions:
          type: string
          description: Permision required to sign the signoff
        completed_by:
          type: string
          description: Person who signed off (Auth0 ID - email)
          default: ""
        completed:
          type: string
          description: Timestamp of the signoff
          format: datetime
    DisableProduct:
      type: object
      required:
      - product
      - branch
      properties:
        product:
          type: string
          example: firefox
          enum:
          - firefox
          - devedition
        branch:
          type: string
          example: releases/mozilla-beta
          enum:
          - projects/maple
          - releases/mozilla-beta
          - releases/mozilla-esr68
          - try
    XPIReleaseInput:
      required:
      - xpi_name
      - xpi_revision
      - xpi_version
      - revision
      - build_number
      type: object
      properties:
        xpi_name:
          type: string
        xpi_revision:
          type: string
        xpi_version:
          type: string
        revision:
          type: string
          description: Manifest revision
        build_number:
          type: integer
    XPIRelease:
      type: object
      required:
        - xpi_name
        - xpi_revision
        - xpi_version
        - build_number
        - name
        - phases
        - status
        - revision
      properties:
        name:
          type: string
        xpi_name:
          type: string
        xpi_revision:
          type: string
        xpi_version:
          type: string
        revision:
          type: string
        build_number:
          type: integer
        status:
          type: string
          example: scheduled
          enum:
          - scheduled
          - shipped
          - aborted
        phases:
          type: array
          items:
            $ref: '#/components/schemas/Phase'
        created:
          type: string
          format: dateTime
        completed:
          type: string
          format: dateTime
