version: 1
policy:
  pullRequests: public
tasks:
  $let:
    release_channel:
      $if: 'tasks_for == "github-pull-request"'
      then: 'PR'
      else:
        $if: 'tasks_for == "github-push" && event.ref in ["refs/heads/production", "refs/heads/dev"]'
        then: '${event.ref[11:]}'
        else: 'none'
  in:
    $let:
      python_version: 'py38'
      # Dependabot, and possibly other things creating pull requests
      # can set `user` to something that can't be used in an e-mail
      # address, so we simply make this static to workaround.
      owner_email: 'release+shipit-ci@mozilla.com'
      ui_bucket:
        # The production bucket name doesn't match the branch name,
        # but the other environments do.
        $if: 'release_channel == "production"'
        then: 'relengstatic-prod-shipitfrontend-static-website'
        else:
          $if: 'release_channel == "dev"'
          # TODO: switch to dev
          then: 'relengstatic-staging-shipitfrontend-static-website'
          else: ''
      shipit_api_url:
        $if: 'release_channel == "production"'
        then: 'https://shipit-api.mozilla-releng.net'
        else:
          $if: 'release_channel == "dev"'
          # TODO: switch to dev
          then: 'https://api.shipit.staging.mozilla-releng.net'
          else: ''
      # Github events have this stuff in different places...
      repo_url:
        $if: 'tasks_for == "github-pull-request"'
        then: '${event.pull_request.head.repo.html_url}'
        else: '${event.repository.html_url}'
      head_sha: {
        $if: 'tasks_for == "github-push"',
        then: '${event.after}',
        else: {
          $if: 'tasks_for == "github-pull-request"',
          then: '${event.pull_request.head.sha}',
          # Assume release event
          else: '${event.release.tag_name}',
        }
      }
      push_docker_image:
        $if: 'tasks_for == "github-pull-request"'
        then: '0'
        else:
          $if: 'tasks_for == "github-push" && event.ref in ["refs/heads/dev", "refs/heads/production"]'
          then: '1'
          else: '0'
      worker_level:
        $if: 'tasks_for == "github-pull-request"'
        then: 't'
        else:
          $if: 'tasks_for == "github-push" && event.ref in ["refs/heads/dev", "refs/heads/production"]'
          then: '3'
          else: 't'
    in:
      $flattenDeep:
        - $if: '(tasks_for == "github-pull-request" && event["action"] in ["edited", "opened", "reopened", "synchronize"]) || tasks_for == "github-push"'
          then:
            - $map: [['py38', 'python:3.8'], ['check', 'python:3.8']]
              each(py):
                taskId: "${as_slugid(py[0])}"
                created: {$fromNow: ''}
                deadline: {$fromNow: '2 hours'}
                provisionerId: releng-t
                workerType: linux
                payload:
                  maxRunTime: 1200
                  image: {$eval: 'py[1]'}
                  command:
                    - /bin/bash
                    - -c
                    - >-
                      git clone ${repo_url} shipit &&
                      cd shipit/api &&
                      git checkout ${head_sha} &&
                      pip install tox &&
                      tox -e ${py[0]}
                metadata:
                  name: Ship-it API ${py[0]} tests (${release_channel})
                  description: Ship-it API ${py[0]} tests (${release_channel})
                  owner: ${owner_email}
                  source: '${repo_url}/raw/${head_sha}/.taskcluster.yml'

            - taskId: {$eval: as_slugid("ui tests")}
              created: {$fromNow: ''}
              deadline: {$fromNow: '2 hours'}
              provisionerId: releng-t
              workerType: linux
              payload:
                maxRunTime: 1200
                image: node:10
                command:
                  - /bin/bash
                  - -c
                  - >-
                    git clone ${repo_url} shipit &&
                    cd shipit/frontend &&
                    git checkout ${head_sha} &&
                    yarn install &&
                    yarn test
              metadata:
                name: Ship-it Frontend tests (${release_channel})
                description: Ship-it Frontend tests (${release_channel})
                owner: ${owner_email}
                source: '${repo_url}/raw/${head_sha}/.taskcluster.yml'

            - $map: [['admin', 'Dockerfile', 'mozilla/releng-shipit-admin'], ['public', 'Dockerfile.public', 'mozilla/releng-shipit-public']]
              each(env):
                taskId: "${as_slugid(env[0])}"
                dependencies:
                  - '${as_slugid(python_version)}'
                  - '${as_slugid("check")}'
                created: {$fromNow: ''}
                deadline: {$fromNow: '24 hours'}
                provisionerId: 'releng-${worker_level}'
                workerType: linux
                routes: []
                payload:
                  maxRunTime: 3600
                  # we need to run really old docker version because taskcluster is using
                  # really old version in their setup
                  # image: docker:stable
                  image: 'docker:1.6.2'
                  env:
                    DOCKERFILE: '${env[1]}'
                    DOCKERHUB_EMAIL: 'release+dockerhub+services@mozilla.com'
                    DOCKERHUB_USER: 'mozillarelengservices'
                    DOCKER_REPO: '${env[2]}'
                    DOCKER_TAG: '${release_channel}'
                    GIT_HEAD_REV: '${head_sha}'
                    PUSH_DOCKER_IMAGE: '${push_docker_image}'
                    REPO_URL: '${repo_url}'
                    SECRET_URL: 'http://taskcluster/secrets/v1/secret/project/releng/shipit/deploy'
                  command:
                    - sh
                    - -lxce
                    - >-
                      cd /tmp &&
                      wget ${repo_url}/archive/${head_sha}.tar.gz &&
                      tar zxf ${head_sha}.tar.gz &&
                      find . &&
                      mv shipit-${head_sha} /src &&
                      cd /src/api &&
                      ./docker.d/generate_version_json.sh &&
                      ./docker.d/build_image.sh &&
                      ./docker.d/push_image.sh
                  features:
                    dind: true
                    taskclusterProxy: true
                scopes:
                  $if: 'push_docker_image == "0"'
                  then: []
                  else:
                    - 'secrets:get:project/releng/shipit/deploy'
                metadata:
                  name: Ship-it API (${env[0]}) docker build (${release_channel})
                  description: Ship-it API (${env[0]}) docker build (${release_channel})
                  owner: ${owner_email}
                  source: '${repo_url}/raw/${head_sha}/.taskcluster.yml'

            - $if: 'release_channel in ["dev", "production"]'
              then:
                - taskId: {$eval: as_slugid("ui-deploy")}
                  created: {$fromNow: ''}
                  deadline: {$fromNow: '2 hours'}
                  provisionerId: 'releng-${worker_level}'
                  workerType: linux
                  scopes:
                    $if: 'push_docker_image == "0"'
                    then: []
                    else:
                      - 'secrets:get:project/releng/shipit/deploy'
                  routes: []
                  payload:
                    env:
                      DEPLOY_SECRET: http://taskcluster/secrets/v1/secret/project/releng/shipit/deploy
                      RELEASE_CHANNEL: ${release_channel}
                      WEBSITE_BUCKET: '${ui_bucket}'
                      SHIPIT_API_URL: '${shipit_api_url}'
                      # To avoid env conditions with TASKCLUSTER_ROOT_URL
                      FRONTEND_TASKCLUSTER_ROOT_URL: 'https://firefox-ci-tc.services.mozilla.com'
                    maxRunTime: 3600
                    image: "node:current"
                    command:
                      - "/bin/bash"
                      - "-c"
                      - "apt-get -q --yes update && apt-get -q --yes install awscli && git clone ${repo_url} shipit && cd shipit/frontend && git checkout ${head_sha} && yarn install && bash ./scripts/deploy"
                    features:
                      taskclusterProxy: true
                  metadata:
                    name: Ship-it UI deploy (${release_channel})
                    description: Ship-it UI deploy (${release_channel})
                    owner: ${owner_email}
                    source: '${repo_url}/raw/${head_sha}/.taskcluster.yml'
